<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Custom PC — Extended Builder (AI + UAE Prices)</title>
  <meta name="description" content="Extended interactive PC builder with live UAE price hooks, full part selection, dynamic estimate and download." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{--accent:#6C5CE7;--muted:#6b7280;--bg:#0f1724;--card:#0b1220;--glass:rgba(255,255,255,0.04)}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#e6eef8;background:linear-gradient(180deg,#071025 0%, #061226 60%);}    
    .wrap{max-width:1200px;margin:28px auto;padding:20px}
    header{display:flex;align-items:center;gap:16px}
    .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#00b4d8);display:flex;align-items:center;justify-content:center;color:white;font-weight:800}
    h1{margin:0;font-size:22px}
    p.lead{margin:4px 0 0;color:var(--muted)}

    .builder-grid{display:grid;grid-template-columns:1fr 360px;gap:20px;margin-top:16px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:12px;backdrop-filter:blur(6px);box-shadow:0 8px 30px rgba(0,0,0,0.5)}

    .part-row{display:grid;grid-template-columns:1fr 120px;gap:10px;align-items:center;margin-bottom:10px}
    .part-row label{font-weight:700;margin-bottom:6px;display:block}
    .input{display:flex;gap:8px}
    .input input[type="text"]{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#e6eef8}
    .btn{padding:9px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#cbd5e1}
    .btn-primary{background:var(--accent);color:white}

    .results{margin-top:8px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);max-height:220px;overflow:auto}
    .result-item{padding:8px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;gap:8px;border:1px solid transparent}
    .result-item:hover{border-color:rgba(255,255,255,0.04);background:rgba(255,255,255,0.01);cursor:pointer}
    .result-title{font-weight:700}
    .result-meta{font-size:13px;color:var(--muted)}

    .selected-list .selected{display:flex;justify-content:space-between;padding:10px;border-bottom:1px dashed rgba(255,255,255,0.03)}

    .summary{margin-top:12px;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent)}
    .est{font-size:18px;font-weight:800;color:var(--accent)}
    .tbd{font-weight:800;color:#ffd166}

    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}

    @media (max-width:980px){.builder-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">PC</div>
      <div>
        <h1>Custom PC — Extended Builder</h1>
        <p class="lead">Full-part selection with real-time UAE price hooks. Final price is <strong>TBD</strong> — shown estimate updates live.</p>
      </div>
    </header>

    <div class="builder-grid">
      <section class="card">
        <h3 style="margin-top:0">Select Parts (search & choose)</h3>
        <p style="color:var(--muted)">Search for a part (name or SKU), view UAE store results and click an item to select it. The estimate will update automatically.</p>

        <div id="partsContainer">
          <!-- Parts list generated by JS -->
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-primary" id="downloadBtn">Download spec</button>
          <button class="btn btn-ghost" id="clearBtn">Clear selections</button>
        </div>
      </section>

      <aside class="card">
        <h3 style="margin-top:0">Build Summary</h3>
        <div class="selected-list" id="selectedList">
          <!-- selected parts rendered here -->
        </div>

        <div class="summary">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-size:13px;color:var(--muted)">Estimated total (live)</div>
              <div class="est" id="estimatePrice">AED 0</div>
            </div>
            <div style="text-align:right">
              <div style="font-size:13px;color:var(--muted)">Final price</div>
              <div class="tbd">TBD</div>
            </div>
          </div>
          <div style="margin-top:8px;font-size:13px;color:var(--muted)">Estimates are pulled in real-time from UAE stores. Final price is TBD until sourcing & warranties are confirmed.</div>
        </div>

        <div style="margin-top:12px" id="compatBox"></div>
        <div style="margin-top:12px;color:var(--muted);font-size:13px">Backend status: <span id="backendPing">unknown</span></div>
      </aside>
    </div>

    <footer>
      <div>© <span id="year"></span> — Built for You. We respect privacy and will never share your email without consent.</div>
    </footer>
  </div>

  <script>
    // Configuration
    const BACKEND = ''; // change to your server origin if needed
    const PART_CATEGORIES = [
      'CPU','GPU','Motherboard','RAM','Storage','PSU','Case','Cooler','Monitor','Keyboard','Mouse','Headset','Operating System'
    ];

    // Demo fallback prices when backend not available
    const DEMO_FALLBACK = {
      CPU:{title:'AMD Ryzen 7 7800X3D',price:1549,store:'Demo Store',sku:'R7-7800X3D',specs:{socket:'AM5'}},
      GPU:{title:'NVIDIA RTX 4070',price:2299,store:'Demo Store',sku:'RTX-4070',specs:{power_w:200}},
      Motherboard:{title:'MSI MAG X670',price:899,store:'Demo Store',sku:'MB-X670',specs:{socket:'AM5'}},
      RAM:{title:'32GB (2x16) DDR5 5600',price:399,store:'Demo Store',sku:'RAM-32-5600',specs:{speed:5600}},
      Storage:{title:'1TB NVMe',price:340,store:'Demo Store',sku:'NVME-1TB',specs:{}},
      PSU:{title:'750W Gold',price:399,store:'Demo Store',sku:'PSU-750G',specs:{watt:750}},
      Case:{title:'Mid Tower',price:320,store:'Demo Store',sku:'CASE-MID',specs:{maxGpuMm:360,cpuCoolerHeightMm:170}},
      Cooler:{title:'Air Cooler (150mm)',price:120,store:'Demo Store',sku:'COOL-AIR-150',specs:{height_mm:150}},
      Monitor:{title:'27" 144Hz',price:1199,store:'Demo Store',sku:'MON-27-144',specs:{}},
      Keyboard:{title:'Mechanical KB',price:249,store:'Demo Store',sku:'KB-MECH',specs:{}},
      Mouse:{title:'Gaming Mouse',price:149,store:'Demo Store',sku:'MOUSE-1',specs:{}},
      Headset:{title:'Gaming Headset',price:179,store:'Demo Store',sku:'HEAD-1',specs:{}},
      'Operating System':{title:'Windows 11 Pro',price:499,store:'Demo Store',sku:'WIN11PRO',specs:{}}
    };

    // State
    const state = { selected: {} };

    // Utilities
    function el(tag,attrs={},inner=''){ const e=document.createElement(tag); for(const k in attrs){ if(k==='class') e.className=attrs[k]; else if(k==='html') e.innerHTML=attrs[k]; else e.setAttribute(k,attrs[k]); } if(inner) e.innerHTML=inner; return e; }

    function formatAED(n){ return 'AED ' + Math.round(n); }

    async function pingBackend(){
      try{
        const r = await fetch(BACKEND + '/api/ping');
        const j = await r.json();
        document.getElementById('backendPing').innerText = j.ok ? 'online' : 'offline';
        return j.ok;
      }catch(e){ document.getElementById('backendPing').innerText = 'offline (demo)'; return false; }
    }

    // Create UI for each part category
    function renderPartsUI(){
      const container = document.getElementById('partsContainer');
      container.innerHTML = '';
      PART_CATEGORIES.forEach(cat=>{
        const id = cat.replace(/\s+/g,'_');
        const row = el('div',{class:'part-row',id:'row-'+id});
        const left = el('div');
        const label = el('label',{},cat);
        const inputWrap = el('div',{class:'input'});
        const input = el('input',{type:'text',id:id+'Search',placeholder:Search ${cat} (name or SKU)});
        const btn = el('button',{class:'btn btn-ghost',type:'button',id:id+'Btn'},'Search');
        inputWrap.appendChild(input); inputWrap.appendChild(btn);
        left.appendChild(label); left.appendChild(inputWrap);

        const right = el('div');
        const chosen = el('div',{id:id+'Chosen',class:'status'},'No selection');
        right.appendChild(chosen);

        row.appendChild(left); row.appendChild(right);
        container.appendChild(row);

        const resultsBox = el('div',{class:'results',id:id+'Results',style:'display:none'});
        container.appendChild(resultsBox);

        btn.addEventListener('click', ()=> doSearch(cat,input.value.trim(),resultsBox,id));
        input.addEventListener('keydown',(ev)=>{ if(ev.key==='Enter'){ doSearch(cat,input.value.trim(),resultsBox,id); } });
      });
    }

    // Search function - calls /api/searchAll?q=... and shows results, or uses DEMO_FALLBACK
    async function doSearch(category,query,resultsBox,id){
      resultsBox.innerHTML = 'Searching...'; resultsBox.style.display='block';
      const q = query || category;
      let backendOk = await pingBackend();
      try{
        if(backendOk){
          const res = await fetch(BACKEND + '/api/searchAll?q=' + encodeURIComponent(q));
          if(!res.ok) throw new Error('search failed');
          const arr = await res.json();
          if(!Array.isArray(arr) || arr.length===0) throw new Error('no results');
          renderResults(arr,resultsBox,category,id);
          return;
        }
      }catch(e){ /* fallback to demo */ }
      // fallback demo single item
      const demo = DEMO_FALLBACK[category] || {title:category+' Example', price:100, store:'Demo', sku:'DEMO-1', specs:{}};
      renderResults([demo],resultsBox,category,id);
    }

    function renderResults(items,resultsBox,category,id){
      resultsBox.innerHTML = '';
      items.forEach(it=>{
        const item = el('div',{class:'result-item'});
        const left = el('div');
        left.innerHTML = <div class='result-title'>${escapeHtml(it.title||it.name||it.title)}</div><div class='result-meta'>${it.store||it.storeName||'Store'} • ${it.sku||''}</div>;
        const right = el('div');
        const price = typeof it.price_aed !== 'undefined' ? (it.price_aed) : (it.price || 0);
        right.innerHTML = <div style='text-align:right'><div style='font-weight:700'>${formatAED(price)}</div><div class='result-meta'>${it.store||''}</div></div>;
        item.appendChild(left); item.appendChild(right);
        item.addEventListener('click', ()=> selectPart(category,it,id));
        resultsBox.appendChild(item);
      });
    }

    function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, (c)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','':'&#96;'})[c]); }

    function selectPart(category,item,id){
      // normalize item fields
      const normalized = {
        title: item.title || item.name || category,
        price: (typeof item.price_aed !== 'undefined') ? item.price_aed : (item.price || 0),
        store: item.store || item.storeName || 'Unknown',
        sku: item.sku || item.id || '',
        specs: item.specs || {}
      };
      state.selected[category] = normalized;
      document.getElementById(id+'Chosen').innerHTML = <strong>${escapeHtml(normalized.title)}</strong><div style='font-size:12px;color:var(--muted)'>${escapeHtml(normalized.store)} • ${escapeHtml(normalized.sku)}</div>;
      // hide results
      const resultsBox = document.getElementById(id+'Results'); if(resultsBox) resultsBox.style.display='none';
      updateEstimate();
      runCompatibilityCheck();
      renderSelectedList();
    }

    function renderSelectedList(){
      const el = document.getElementById('selectedList'); el.innerHTML='';
      PART_CATEGORIES.forEach(cat=>{
        const sel = state.selected[cat];
        const row = el('div',{class:'selected-item'});
        if(sel){
          row.innerHTML = <div class='selected'><div><strong>${escapeHtml(cat)}</strong><div style='font-size:13px;color:var(--muted)'>${escapeHtml(sel.title)}</div></div><div style='text-align:right'><div style='font-weight:700'>${formatAED(sel.price)}</div><div style='font-size:12px;color:var(--muted)'>${escapeHtml(sel.store)}</div></div></div>;
        } else {
          row.innerHTML = <div class='selected'><div><strong>${escapeHtml(cat)}</strong><div style='font-size:13px;color:var(--muted)'>Not selected</div></div><div style='text-align:right'><div style='font-weight:700;color:var(--muted)'>—</div></div></div>;
        }
        el.appendChild(row);
      });
    }

    function updateEstimate(){
      let total = 0;
      PART_CATEGORIES.forEach(cat=>{ const s = state.selected[cat]; if(s && typeof s.price === 'number') total += s.price; });
      document.getElementById('estimatePrice').innerText = formatAED(total);
    }

    // Download spec (text)
    function downloadSpec(){
      const name = (document.getElementById('name')?.value || 'Custom_Build').replace(/[^a-zA-Z0-9_\- ]/g,'');
      let content = Build specification - ${name}\nGenerated: ${new Date().toLocaleString()}\n\n;
      let total = 0;
      PART_CATEGORIES.forEach(cat=>{
        const s = state.selected[cat];
        if(s){ content += ${cat}: ${s.title} | ${s.store} | ${s.sku} | ${formatAED(s.price)}\n; total += s.price; }
        else content += ${cat}: Not selected\n;
      });
      content += \nEstimated total (live): ${formatAED(total)}\nFinal price: TBD\n;
      const blob = new Blob([content],{type:'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = name + '_spec.txt'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    function clearSelections(){ state.selected = {}; renderSelectedList(); updateEstimate(); // reset chosen displays
      PART_CATEGORIES.forEach(cat=>{ const id = cat.replace(/\s+/g,'_'); const elCh = document.getElementById(id+'Chosen'); if(elCh) elCh.innerHTML='No selection'; const resBox = document.getElementById(id+'Results'); if(resBox) resBox.style.display='none'; }); }

    // Compatibility check - simple local rules, and tries backend /api/compatibility
    async function runCompatibilityCheck(){
      const payload = {cpu: state.selected['CPU']||null, gpu: state.selected['GPU']||null, ram_gb: state.selected['RAM'] ? parseInt((state.selected['RAM'].title||'').match(/(\d+)/)?.[0]||16,10) : null, case: state.selected['Case']?state.selected['Case'].title:null};
      // try backend
      try{
        const res = await fetch(BACKEND + '/api/compatibility', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        if(res.ok){ const j = await res.json(); showCompatUI(j); return; }
      }catch(e){ /* fallback */ }
      // local rules
      const issues = [];
      if(payload.cpu && payload.cpu.specs && payload.cpu.specs.socket && payload.case && payload.case.toLowerCase().includes('mini')) issues.push('Mini cases may need low-profile coolers.');
      showCompatUI({compatible: issues.length===0, issues, suggestions:[]});
    }

    function showCompatUI(obj){ const box = document.getElementById('compatBox'); if(!obj) { box.innerHTML=''; return; } if(obj.compatible) box.innerHTML = <div style='color:#7ee787;font-weight:700'>Parts compatible</div> + (obj.issues && obj.issues.length? <div style='color:var(--muted)'>${obj.issues.join('; ')}</div>:''); else box.innerHTML = <div style='color:#ff9671;font-weight:700'>Compatibility issues</div><div style='color:var(--muted)'>${(obj.issues||[]).join('; ')}</div>; }

    // Wire buttons
    document.addEventListener('click',(e)=>{
      if(e.target && e.target.id==='downloadBtn') downloadSpec();
      if(e.target && e.target.id==='clearBtn') clearSelections();
    });

    // Kickoff
    (async function init(){
      renderPartsUI(); renderSelectedList(); document.getElementById('year').innerText = new Date().getFullYear();
      await pingBackend(); updateEstimate();
      // auto-search category defaults to fetch basic demo items (non-blocking)
      PART_CATEGORIES.slice(0,3).forEach(cat=>{ const id = cat.replace(/\s+/g,'_'); doSearch(cat,cat,document.getElementById(id+'Results'),id); });
    })();
  </script>
</body>
</html>
